<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ì´ë©”ì¼</title>
  <link rel="stylesheet" href="/main/css/main-style.css"> <!-- ë©”ì¸ ìŠ¤íƒ€ì¼ ì—°ê²° -->
  <script src="/main/js/main.js"></script> <!-- ë©”ì¸ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—°ê²° -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=keyboard_arrow_down" />
  <link rel="stylesheet" href="/sidemenu/mail/css/mailDetail.css">
</head>
<body>
<header>
  <div class="side-menu-bar">
    <ul>
      <li>
        <a href="/main">
          <img src="/img/icon/logo.png" alt="PetHarmony Logo" style="width: 120px; height: auto; padding-top: 10px; padding-left: 40px;">
        </a>
      </li>
      <li><a href="http://localhost:9595/schedule">ê·¼íƒœê´€ë¦¬</a></li>
      <li><a href="http://localhost:9595/messenger">ë©”ì‹ ì €(ì±„íŒ…)</a></li>
      <li><a href="http://localhost:9595/mail">ìª½ì§€</a></li> <!-- ì´ë©”ì¼ì„ ìª½ì§€ë¡œ ë³€ê²½ -->
      <li><a href="http://localhost:9595/adoption">ì…ì–‘ê´€ë¦¬</a></li>
      <li><a href="http://localhost:9595/animals">êµ¬ì¡°ë™ë¬¼</a></li> <!-- ì„œë¸Œë©”ë‰´ë¥¼ ìƒìœ„ ë©”ë‰´ë¡œ ì´ë™ -->
      <li><a href="http://localhost:9595/stock">ì¬ê³ ê´€ë¦¬</a></li>
      <li><a href="http://localhost:9595/board">ì „ì‚¬ê²Œì‹œíŒ</a></li>
      <li><a href="http://localhost:9595/mypage">ë§ˆì´í˜ì´ì§€</a></li>
      <li><a href="http://localhost:9595/employee">ì§ì›ì •ë³´</a></li>
      <li><a href="http://localhost:9595/approval">ê²°ì¬ìš”ì²­</a></li>
      <li class="admin-menu">
        <div class="admin-menu-wrapper">
          <a href="http://localhost:9595/manager">ê´€ë¦¬ìì „ìš©
            <span class="material-symbols-outlined">keyboard_arrow_down</span>
          </a>
        </div>
        <ul class="sub-menu">
          <li><a href="http://localhost:9595/manager">ê´€ë¦¬ìí˜ì´ì§€</a></li>
          <li><a href="http://localhost:9595/employeeRegister">ì‚¬ì›ë“±ë¡</a></li>
          <li><a href="http://localhost:9595/employeeManagement">ì§ì›ê´€ë¦¬</a></li>
          <li><a href="http://localhost:9595/approvalBox">ê²°ì¬í•¨</a></li>
        </ul>
      </li>
    </ul>
    <div class="current-user">
      <img id="unique-user-profile-picture" src="" alt="Profile Picture" style="width: 50px; height: 50px; border-radius: 50%;">
      <div id="unique-user-info">
        <div id="unique-user-department" class="user-info-box"></div>
        <div class="name-position">
          <div id="unique-user-name-display" class="user-info-box"></div>
          <div id="unique-user-position" class="user-info-box"></div>
        </div>
      </div>
      <form id="logout-form-unique" action="/logout" method="post" onsubmit="return confirmLogoutUnique();">
        <button id="logout-button-unique" class="logout-button-unique" type="button" onclick="confirmLogoutUnique()">ë¡œê·¸ì•„ì›ƒ</button> <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
      </form>
    </div>
  </div>
</header>
<div class="change-screen-mailDetail">
  <div id="change-screen-content">
    <div class="form">
      <div class="navigation">
        <nav>
          <ul>
            <li style="font-size: 20px;">
              <a th:href="@{/mail}" style="text-decoration: none;">
                <b>ğŸ“¥&nbsp;&nbsp;&nbsp;&nbsp;ë°›ì€ìª½ì§€í•¨</b>
              </a>
            </li><br><br><br>

            <li style="font-size: 20px;">
              <a th:href="@{/mail/sent}" style="text-decoration: none;">
                <b>ğŸ“¤&nbsp;&nbsp;&nbsp;&nbsp;ë³´ë‚¸ìª½ì§€í•¨</b>
              </a>
            </li><br><br><br>

            <li style="font-size: 20px;">
              <a href="/mail/important" style="text-decoration: none;">
                <b>â­&nbsp;&nbsp;&nbsp;&nbsp;ì¤‘ìš”ìª½ì§€í•¨</b>
              </a>
            </li><br><br><br>

            <li style="font-size: 20px;">
              <a href="/mail/trash" style="text-decoration: none;">
                <b>âŒ&nbsp;&nbsp;&nbsp;&nbsp;íœ´ì§€í†µ</b>
              </a>
            </li><br><br><br>

            <li style="font-size: 20px;">
              <a href="/mail/archived" style="text-decoration: none;">
                <b>ğŸ“¦&nbsp;&nbsp;&nbsp;&nbsp;ë³´ê´€í•¨</b>
              </a>
              <br><br>
            </li>
          </ul>
          <button id="messageModalBtn" class="styled-button">ğŸ– ìª½ì§€ ì“°ê¸°</button>
        </nav>
      </div>
      <div class="form1">
        <div class="main-button">
        </div>
        <div class="form-main">
          <h2 th:text="${mail.title}"></h2>
          <small th:text="'ë³´ë‚¸ì‚¬ëŒ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + ${mail.senderName}"></small><br><br>
          <small th:text="'ë°›ëŠ”ì‚¬ëŒ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + ${mail.recipientName}"></small><br><br>
          <small th:text="'ë‚ ì§œ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + ${#dates.format(mail.sendDate, 'yyyy-MM-dd')}"></small>
          <a class="main-page" th:href="@{/sidemenu/mail}">ëª©ë¡</a>
        </div>
        <div class="content-box" th:text="${mail.content}"></div>
        <div id="messageModal" class="modal">
          <div class="modal-content">
            <form class=modal2-form id="messageForm" action="/sidemenu/mail/regist" method="post">
              <span class="close-btn" id="closeModalBtn">&times;</span>
              <h2>ìª½ì§€ ë³´ë‚´ê¸°</h2>
              <button id="openModalBtn" class="styled-button2"><b>ğŸ” ì°¾ê¸°</b></button>
              <div class="form-group">
                <label for="recipient">ë°›ëŠ” ì‚¬ëŒ</label>
                <input class="textbox" type="text" id="recipient" name="recipient" placeholder="ë°›ëŠ” ì‚¬ëŒì„ ì…ë ¥í•˜ì„¸ìš”" required readonly>
              </div>
              <div class="form-name">
                <label>ì œëª©</label>
                <input class="textbox1-1" type="text" id="title" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
              </div>
              <div class="form-group2">
                <label for="message">ìª½ì§€ ë‚´ìš©</label>
                <textarea id="message" name="content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
              </div>
              <button type="submit" id="sendMessageBtn" class="submit">ë³´ë‚´ê¸°</button>
              <input type="hidden" id="recipient_id" name="recipientId">
              <input type="hidden" id="recipient_name" name="recipientName">
            </form>
          </div>
        </div>
        <div id="addressBookModal" class="modal2">
          <div class="modal-content2">
            <span class="close-btn" id="closeModalBtn2">&times;</span>
            <h2>ì£¼ì†Œë¡</h2>
            <div class="search-bar">
              <input class="textbox2" type="text" id="searchInput2" placeholder="ì§ì› ê²€ìƒ‰..." oninput="filterEmployees()">
            </div>
            <div id="addressBookContainer2">
              <div class="department-group">
                <h3>ğŸ“‚ ê²½ì˜ë¶€</h3>
                <ul class="employee-list" id="managementDept"></ul>
              </div>
              <div class="department-group">
                <h3>ğŸ“‚ ì• ê²¬ë‹´ë‹¹ë¶€</h3>
                <ul class="employee-list" id="dogDept"></ul>
              </div>
              <div class="department-group">
                <h3>ğŸ“‚ ë§ˆì¼€íŒ…ë¶€</h3>
                <ul class="employee-list" id="marketingDept"></ul>
              </div>
              <div class="department-group">
                <h3>ğŸ“‚ ì˜ì—…ë¶€</h3>
                <ul class="employee-list" id="salesDept"></ul>
              </div>
              <div class="department-group">
                <h3>ğŸ“‚ ë¬¼ë¥˜ë¶€</h3>
                <ul class="employee-list" id="logisticsDept"></ul>
              </div>
              <div class="department-group">
                <h3>ğŸ“‚ ê³ ê°ì—…ë¬´ë¶€</h3>
                <ul class="employee-list" id="customerDept"></ul>
              </div>
            </div>
            <button id="submitSelection2" onclick="submitSelections()" class="styled-button3">ì„ íƒ ì™„ë£Œ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
<script>
  document.getElementById('messageModalBtn').addEventListener('click', function() {
    document.getElementById('messageModal').style.display = 'block';
  });

  document.getElementById('closeModalBtn').addEventListener('click', function() {
    document.getElementById('messageModal').style.display = 'none';
  });

  document.getElementById('openModalBtn').addEventListener('click', function() {
    document.getElementById('addressBookModal').style.display = 'block';
  });

  document.getElementById('closeModalBtn2').addEventListener('click', function() {
    document.getElementById('addressBookModal').style.display = 'none';
  });

  function moveMails(targetFolder) {
    const selectedMailIds = getSelectedMailIds();

    if (selectedMailIds.length === 0) {
      alert("ì´ë™í•  ë©”ì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    fetch('/mail/move', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        emailCode: selectedMailIds.join(","),
        recipientFolder: targetFolder
      })
    })
            .then(response => {
              if (!response.ok) {
                throw new Error("ë©”ì¼ ì´ë™ ì‹¤íŒ¨");
              }
              return response.text();
            })
            .then(data => {
              alert(data);
              location.reload();
            })
            .catch(error => {
              console.error("ë©”ì¼ ì´ë™ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            });
  }

  let selectedRecipients = [];

  // ì§ì› ì„ íƒ ë° í•´ì œ ì²˜ë¦¬
  function selectEmployee(employee, checkbox) {
    const recipientField = document.getElementById('recipient');
    const recipientIdField = document.getElementById('recipient_id');
    const recipientNameField = document.getElementById('recipient_name');

    // ì§ì› ì •ë³´ê°€ ì´ë¯¸ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
    const recipientIndex = selectedRecipients.findIndex(emp => emp.empCode === employee.empCode);

    if (checkbox.checked) {
      // ì²´í¬ë°•ìŠ¤ê°€ ì„ íƒë˜ë©´, ìˆ˜ì‹ ì ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
      if (recipientIndex === -1) {
        selectedRecipients.push({
          empCode: employee.empCode,
          empName: employee.empName
        });
      }
    } else {
      // ì²´í¬ë°•ìŠ¤ê°€ í•´ì œë˜ë©´, ìˆ˜ì‹ ì ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
      if (recipientIndex !== -1) {
        selectedRecipients.splice(recipientIndex, 1);
      }
    }

    // ì„ íƒëœ ì§ì›ë“¤ ê°±ì‹ 
    updateRecipientField();
  }

  // ì„ íƒëœ ì§ì›ë“¤ ê°±ì‹ 
  function updateRecipientField() {
    const recipientField = document.getElementById('recipient');
    const recipientIdField = document.getElementById('recipient_id');
    const recipientNameField = document.getElementById('recipient_name');

    if (selectedRecipients.length > 0) {
      recipientField.value = selectedRecipients.map(emp => emp.empName).join(', ');
      recipientIdField.value = selectedRecipients.map(emp => emp.empCode).join(',');
      recipientNameField.value = selectedRecipients.map(emp => emp.empName).join(',');
    } else {
      recipientField.value = '';
      recipientIdField.value = '';
      recipientNameField.value = '';
    }
  }

  // í˜ì´ì§€ ë¡œë”© ì‹œ ì§ì› ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  window.onload = function() {
    fetchEmployees();
  };

  function fetchEmployees() {
    const departments = {
      'ê²½ì˜ë¶€': document.getElementById('managementDept'),
      'ì• ê²¬ë‹´ë‹¹ë¶€': document.getElementById('dogDept'),
      'ë§ˆì¼€íŒ…ë¶€': document.getElementById('marketingDept'),
      'ì˜ì—…ë¶€': document.getElementById('salesDept'),
      'ë¬¼ë¥˜ë¶€': document.getElementById('logisticsDept'),
      'ê³ ê°CSì—…ë¬´ë¶€': document.getElementById('customerDept')
    };

    fetch('/mail/employees')
            .then(response => response.json())
            .then(data => {
              data.forEach(employee => {
                const empName = employee.empName || 'N/A';
                const jobName = employee.jobDTO ? employee.jobDTO.jobName : 'N/A';
                const deptName = employee.deptDTO ? employee.deptDTO.deptName : 'N/A';

                if (departments[deptName]) {
                  const li = document.createElement('li');
                  const checkbox = document.createElement('input');
                  checkbox.type = "checkbox";
                  checkbox.classList.add("select-item");
                  checkbox.value = employee.empCode;
                  checkbox.setAttribute('data-name', empName);  // ì—¬ê¸°ì„œ nameì„ data-nameì— ì„¤ì •

                  // ì§ì› ì´ë¦„ê³¼ ì§ê¸‰ì„ liì— ì¶”ê°€
                  const nameText = document.createTextNode(`${empName} (${jobName})`);

                  // ì²´í¬ë°•ìŠ¤ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ê³ , ê·¸ í›„ í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                  li.appendChild(checkbox);
                  li.appendChild(nameText);
                  li.onclick = () => selectEmployee(employee, checkbox);

                  // ê° liì— data-name ì†ì„±ì„ ì„¤ì •í•´ì¤ë‹ˆë‹¤.
                  li.setAttribute('data-name', empName.toLowerCase()); // ê²€ìƒ‰ì„ ìœ„í•´ data-nameì— empNameì„ ì†Œë¬¸ìë¡œ ì„¤ì •

                  departments[deptName].appendChild(li);
                }
              });

              // ì„ íƒëœ ì§ì›ë“¤ì„ í‘œì‹œ
              restoreSelectedEmployees();
            })
            .catch(error => {
              console.error('ì§ì› ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            });
  }

  // ì„ íƒëœ ì§ì›ë“¤ì„ ê°±ì‹ 
  function restoreSelectedEmployees() {
    const checkboxes = document.querySelectorAll('.select-item');
    checkboxes.forEach(checkbox => {
      const empCode = checkbox.value;
      // ì„ íƒëœ ì§ì›ì˜ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬ ìƒíƒœë¡œ ìœ ì§€
      const isSelected = selectedRecipients.some(emp => emp.empCode === empCode);
      checkbox.checked = isSelected;
    });
  }

  function submitSelections() {
    updateRecipientField();  // ì„ íƒëœ ì§ì›ë“¤ ê°±ì‹ 

    const recipientIdsField = document.getElementById('recipient_id');
    const recipientNameField = document.getElementById('recipient_name');

    // ì„ íƒëœ ì§ì›ì´ ì—†ìœ¼ë©´ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
    if (!recipientIdsField || !recipientIdsField.value || !recipientNameField || !recipientNameField.value) {
      alert("ë°›ëŠ” ì‚¬ëŒì„ ì„ íƒí•´ ì£¼ì„¸ìš”!");
      return;
    }

    // ì„ íƒëœ ì§ì›ì´ ìˆìœ¼ë©´, ì¶”ê°€ ì‘ì—…
    const addressBookModal = document.getElementById('addressBookModal');
    if (addressBookModal) {
      addressBookModal.style.display = 'none';
    }
  }

  // ê²€ìƒ‰ëœ ì§ì› í•­ëª© ì €ì¥
  let filteredItems = [];

  // ê²€ìƒ‰ í•„í„°ë§ í•¨ìˆ˜
  function filterEmployees() {
    const searchInput = document.getElementById('searchInput2').value.toLowerCase();
    const employeeListItems = document.querySelectorAll('#addressBookContainer2 .employee-list li');

    filteredItems = []; // ê²€ìƒ‰ëœ í•­ëª© ì´ˆê¸°í™”

    employeeListItems.forEach(item => {
      const name = item.getAttribute('data-name').toLowerCase();
      if (name.includes(searchInput)) {
        item.style.display = ''; // ê²€ìƒ‰ëœ í•­ëª© ë³´ì´ê¸°
        filteredItems.push(item); // ê²€ìƒ‰ëœ í•­ëª© ì¶”ê°€
      } else {
        item.style.display = 'none'; // ê²€ìƒ‰ë˜ì§€ ì•Šì€ í•­ëª© ìˆ¨ê¸°ê¸°
      }
    });
  }

  // "ì „ì²´ ì„ íƒ" ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
  const selectAllCheckbox = document.getElementById('selectAllManagementDept');
  selectAllCheckbox.addEventListener('change', function () {
    const isChecked = selectAllCheckbox.checked;

    // ê²€ìƒ‰ëœ í•­ëª©ë“¤ë§Œ ì„ íƒí•˜ë„ë¡ í•„í„°ë§ëœ í•­ëª©ì„ ëŒ€ìƒìœ¼ë¡œ ì²˜ë¦¬
    const filteredItems = document.querySelectorAll('#addressBookContainer2 .employee-list li');

    filteredItems.forEach(item => {
      const checkbox = item.querySelector('.select-item');
      checkbox.checked = isChecked; // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½

      const empCode = checkbox.value;
      const empName = checkbox.getAttribute('data-name');

      const recipientIndex = selectedRecipients.findIndex(emp => emp.empCode === empCode);

      if (isChecked && recipientIndex === -1) {
        selectedRecipients.push({ empCode, empName }); // ì„ íƒëœ ì§ì› ì¶”ê°€
      } else if (!isChecked && recipientIndex !== -1) {
        selectedRecipients.splice(recipientIndex, 1); // ì„ íƒ í•´ì œëœ ì§ì› ì œê±°
      }
    });

    updateRecipientField(); // ì„ íƒëœ ì§ì›ë“¤ ê°±ì‹ 
  });

  function toggleSelectAll(source, isAddressBook = false) {
    const checkboxes = isAddressBook
            ? document.querySelectorAll('.employee-list .select-item') // ì£¼ì†Œë¡ì—ì„œì˜ ì„ íƒ
            : document.querySelectorAll('.post-list .select-item');  // ë©”ì¼ ëª©ë¡ì—ì„œì˜ ì„ íƒ

    checkboxes.forEach(function(checkbox) {
      checkbox.checked = source.checked;
      const empCode = checkbox.value;
      const empName = checkbox.getAttribute('data-name');

      const recipientIndex = selectedRecipients.findIndex(emp => emp.empCode === empCode);

      if (checkbox.checked) {
        // ì²´í¬ë°•ìŠ¤ê°€ ì„ íƒë˜ë©´ ìˆ˜ì‹ ì ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
        if (recipientIndex === -1) {
          selectedRecipients.push({
            empCode: empCode,
            empName: empName
          });
        }
      } else {
        // ì²´í¬ë°•ìŠ¤ê°€ í•´ì œë˜ë©´ ìˆ˜ì‹ ì ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°
        if (recipientIndex !== -1) {
          selectedRecipients.splice(recipientIndex, 1);
        }
      }
    });

    // ì„ íƒëœ ì§ì›ë“¤ ê°±ì‹ 
    updateRecipientField();
  }

  window.onload = function() {
    // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ì´ë¦„ì„ senderName í•„ë“œì— ì„¤ì •
    const senderId = 'í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ ìš©ì ì½”ë“œ'; // ì‹¤ì œë¡œ ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ê°’ì„ ì‚¬ìš©
    document.getElementById('senderId').value = senderId;

    fetchEmployees();
  };

  function getSelectedMailIds() {
    const selected = [];
    document.querySelectorAll('input.select-item:checked').forEach(function (checkbox) {
      selected.push(checkbox.value);
    });
    return selected;
  }
</script>
</html>